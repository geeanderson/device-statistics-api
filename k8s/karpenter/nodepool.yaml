# NodePool — defines what kind of nodes Karpenter can provision for application pods.
# Apply after ec2nodeclass.yaml is in place.
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: default
spec:
  template:
    metadata:
      labels:
        role: application

    spec:
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: default

      requirements:
        # amd64 only — images are not built for arm64
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]

        # on-demand for predictability; switch to ["spot", "on-demand"] to cut costs
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]

        # General purpose and compute optimized families
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t", "m", "c"]

        # Avoid instance types older than generation 2
        - key: karpenter.k8s.aws/instance-generation
          operator: Gt
          values: ["2"]

        # Exclude sizes too small for EKS workloads
        - key: karpenter.k8s.aws/instance-size
          operator: NotIn
          values: ["nano", "micro", "small"]

  # Safety cap — Karpenter won't provision beyond these totals
  limits:
    cpu: "50"
    memory: 100Gi

  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    # Wait 30s before consolidating — avoids churn during brief load spikes
    consolidateAfter: 30s
